// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.23.0
// source: feeds.sql

package models

import (
	"context"
	"time"
)

const deleteFeed = `-- name: DeleteFeed :exec
delete from feeds
where did = $1
    and rkey = $2
`

type DeleteFeedParams struct {
	Did  string
	Rkey string
}

func (q *Queries) DeleteFeed(ctx context.Context, arg DeleteFeedParams) error {
	_, err := q.db.ExecContext(ctx, deleteFeed, arg.Did, arg.Rkey)
	return err
}

const deleteFeedPostsForDid = `-- name: DeleteFeedPostsForDid :exec
delete from feed_posts
where post_did = $1
`

func (q *Queries) DeleteFeedPostsForDid(ctx context.Context, postDid string) error {
	_, err := q.db.ExecContext(ctx, deleteFeedPostsForDid, postDid)
	return err
}

const getFeedPosts = `-- name: GetFeedPosts :many
with pinned_post as (
    select pinned_did,
        pinned_rkey
    from feeds f
    where f.did = $1
        and f.rkey = $2
),
feed_posts as (
    select p.did,
        p.rkey
    from posts p
        join feed_posts fp on p.did = fp.post_did
        and p.rkey = fp.post_rkey
    where fp.feed_did = $1
        and fp.feed_rkey = $2
        and p.created_at > $3
    order by fp.weight desc
    limit $4
)
select did,
    rkey
from (
        select pinned_did as did,
            pinned_rkey as rkey
        from pinned_post p
        where p.pinned_did <> ''
            and p.pinned_rkey <> ''
        union all
        select did,
            rkey
        from feed_posts
    ) as results
`

type GetFeedPostsParams struct {
	Did       string
	Rkey      string
	CreatedAt time.Time
	Limit     int32
}

type GetFeedPostsRow struct {
	Did  string
	Rkey string
}

func (q *Queries) GetFeedPosts(ctx context.Context, arg GetFeedPostsParams) ([]GetFeedPostsRow, error) {
	rows, err := q.db.QueryContext(ctx, getFeedPosts,
		arg.Did,
		arg.Rkey,
		arg.CreatedAt,
		arg.Limit,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetFeedPostsRow
	for rows.Next() {
		var i GetFeedPostsRow
		if err := rows.Scan(&i.Did, &i.Rkey); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getFeedPostsCursor = `-- name: GetFeedPostsCursor :many
with referenceposttime as (
    select created_at
    from posts
    where posts.did = $5
        and posts.rkey = $6
)
select p.did,
    p.rkey
from posts p
    join feed_posts fp on p.did = fp.post_did
    and p.rkey = fp.post_rkey
where fp.feed_did = $1
    and fp.feed_rkey = $2
    and p.created_at > $3
    and p.created_at < (
        select created_at
        from referenceposttime
    )
order by fp.weight desc
limit $4
`

type GetFeedPostsCursorParams struct {
	FeedDid   string
	FeedRkey  string
	CreatedAt time.Time
	Limit     int32
	Did       string
	Rkey      string
}

type GetFeedPostsCursorRow struct {
	Did  string
	Rkey string
}

func (q *Queries) GetFeedPostsCursor(ctx context.Context, arg GetFeedPostsCursorParams) ([]GetFeedPostsCursorRow, error) {
	rows, err := q.db.QueryContext(ctx, getFeedPostsCursor,
		arg.FeedDid,
		arg.FeedRkey,
		arg.CreatedAt,
		arg.Limit,
		arg.Did,
		arg.Rkey,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetFeedPostsCursorRow
	for rows.Next() {
		var i GetFeedPostsCursorRow
		if err := rows.Scan(&i.Did, &i.Rkey); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getFeedPostsForDid = `-- name: GetFeedPostsForDid :many
select feed_did, feed_rkey, post_did, post_rkey, weight
from feed_posts
where post_did = $1
`

func (q *Queries) GetFeedPostsForDid(ctx context.Context, postDid string) ([]FeedPost, error) {
	rows, err := q.db.QueryContext(ctx, getFeedPostsForDid, postDid)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []FeedPost
	for rows.Next() {
		var i FeedPost
		if err := rows.Scan(
			&i.FeedDid,
			&i.FeedRkey,
			&i.PostDid,
			&i.PostRkey,
			&i.Weight,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getFeeds = `-- name: GetFeeds :many
select did, rkey, pinned_did, pinned_rkey
from feeds
`

func (q *Queries) GetFeeds(ctx context.Context) ([]Feed, error) {
	rows, err := q.db.QueryContext(ctx, getFeeds)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Feed
	for rows.Next() {
		var i Feed
		if err := rows.Scan(
			&i.Did,
			&i.Rkey,
			&i.PinnedDid,
			&i.PinnedRkey,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getFeedsForDid = `-- name: GetFeedsForDid :many
select did, rkey, pinned_did, pinned_rkey
from feeds
where did = $1
`

func (q *Queries) GetFeedsForDid(ctx context.Context, did string) ([]Feed, error) {
	rows, err := q.db.QueryContext(ctx, getFeedsForDid, did)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Feed
	for rows.Next() {
		var i Feed
		if err := rows.Scan(
			&i.Did,
			&i.Rkey,
			&i.PinnedDid,
			&i.PinnedRkey,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const upsertFeed = `-- name: UpsertFeed :exec
insert into feeds (did, rkey, pinned_did, pinned_rkey)
values ($1, $2, $3, $4) on conflict (did, rkey) do
update
set pinned_did = excluded.pinned_did,
    pinned_rkey = excluded.pinned_rkey
`

type UpsertFeedParams struct {
	Did        string
	Rkey       string
	PinnedDid  string
	PinnedRkey string
}

func (q *Queries) UpsertFeed(ctx context.Context, arg UpsertFeedParams) error {
	_, err := q.db.ExecContext(ctx, upsertFeed,
		arg.Did,
		arg.Rkey,
		arg.PinnedDid,
		arg.PinnedRkey,
	)
	return err
}

const upsertFeedPost = `-- name: UpsertFeedPost :exec
insert into feed_posts (
        feed_did,
        feed_rkey,
        post_did,
        post_rkey,
        weight
    )
values ($1, $2, $3, $4, $5) on conflict (feed_did, feed_rkey, post_did, post_rkey) do
update
set weight = excluded.weight
`

type UpsertFeedPostParams struct {
	FeedDid  string
	FeedRkey string
	PostDid  string
	PostRkey string
	Weight   int32
}

func (q *Queries) UpsertFeedPost(ctx context.Context, arg UpsertFeedPostParams) error {
	_, err := q.db.ExecContext(ctx, upsertFeedPost,
		arg.FeedDid,
		arg.FeedRkey,
		arg.PostDid,
		arg.PostRkey,
		arg.Weight,
	)
	return err
}
